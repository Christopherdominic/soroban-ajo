generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // KYC/AML fields
  kycLevel        Int      @default(0)                     // 0=no verification, 1=email/phone, 2=ID, 3=full
  kycStatus       String   @default("none")               // pending/approved/rejected/none
  kycRequestedAt  DateTime?
  kycVerifiedAt   DateTime?
  kycRejectedAt   DateTime?
  kycDocuments    Json?                                   // metadata about submitted documents

  groups        GroupMember[]
  contributions Contribution[]
}

model Group {
  id                String   @id
  name              String
  contributionAmount BigInt
  frequency         Int
  maxMembers        Int
  currentRound      Int      @default(0)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  members        GroupMember[]
  contributions  Contribution[]
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  joinedAt  DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id])
  user  User  @relation(fields: [userId], references: [walletAddress])

  @@unique([groupId, userId])
}

model Contribution {
  id          String   @id @default(cuid())
  groupId     String
  userId      String
  amount      BigInt
  round       Int
  txHash      String   @unique
  createdAt   DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id])
  user  User  @relation(fields: [userId], references: [walletAddress])

  @@index([groupId, round])
}

// Documents uploaded as part of the KYC process
model KycDocument {
  id          String   @id @default(cuid())
  userId      String
  docType     String
  status      String   @default("pending")
  ipfsCid     String
  uploadedAt  DateTime @default(now())
  reviewedBy  String?
  reviewedAt  DateTime?
  notes       String?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
